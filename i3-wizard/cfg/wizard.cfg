\
# ===== i3 Wizard chain (DK BE v2, Beacon Touch-ready, silent) =====

# Utility: smart level (supports z_tilt or QGL; falls back to homing Z)
[gcode_macro _SMART_LEVEL]
description: "Prefer Z_TILT_ADJUST, else QUAD_GANTRY_LEVEL, else home Z"
gcode:
  {% if printer.configfile.settings.z_tilt is defined %}
    Z_TILT_ADJUST
  {% elif printer.configfile.settings.quad_gantry_level is defined %}
    QUAD_GANTRY_LEVEL
  {% else %}
    G28 Z
  {% endif %}

# ----- Steps -----
[gcode_macro STEP_QGL]
gcode:
  KS_NOTIFY TITLE="Wizard" MSG="üîß Step 1/5: Gantry/Bed Level" DUR=6
  ANIM_START STYLE=spinner TEXT="Leveling‚Ä¶"
  _SMART_LEVEL
  ANIM_STOP
  KS_NOTIFY TITLE="Wizard" MSG="‚úÖ Level complete" DUR=4

[gcode_macro STEP_MESH]
gcode:
  KS_NOTIFY TITLE="Wizard" MSG="üó∫Ô∏è Step 2/5: Bed Mesh" DUR=6
  ANIM_START STYLE=dots TEXT="Meshing‚Ä¶"
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE
  SAVE_CONFIG
  ANIM_STOP
  KS_NOTIFY TITLE="Wizard" MSG="üíæ Mesh saved" DUR=4

# Pressure Advance step (neutral: lets user run their preferred PA test)
[gcode_macro STEP_PA]
gcode:
  KS_NOTIFY TITLE="Wizard" MSG="üß™ Step 3/5: Pressure Advance (manual test)" DUR=7
  RESPOND TYPE=note MSG="Load your PA test model or run your PA macro. Press RESUME here when you are done to continue."
  PAUSE
  KS_NOTIFY TITLE="Wizard" MSG="PA step acknowledged. Remember to SAVE_CONFIG if you set a new PA." DUR=6

[gcode_macro STEP_IS]
gcode:
  KS_NOTIFY TITLE="Wizard" MSG="üìä Step 4/5: Input Shaper (Beacon Touch)" DUR=7
  ANIM_START STYLE=spinner TEXT="Shaper X‚Ä¶"
  SHAPER_CALIBRATE AXIS=X
  ANIM_STOP
  ANIM_START STYLE=spinner TEXT="Shaper Y‚Ä¶"
  SHAPER_CALIBRATE AXIS=Y
  ANIM_STOP
  SAVE_CONFIG
  KS_NOTIFY TITLE="Wizard" MSG="‚úÖ IS complete & saved" DUR=5

# ----- Wizard entry -----
[gcode_macro INITIAL_SETUP]
description: "One-click setup (animations, KS prompts) ‚Äî DK BE v2"
gcode:
  M117 Starting One-Click Wizard‚Ä¶
  G90
  G28
  STEP_QGL
  KS_PROMPT_OK_CANCEL TITLE="Level done" MSG="Proceed to Mesh?" OK="Next" ONOK="STEP_MESH"
  KS_PROMPT_OK_CANCEL TITLE="Mesh done"  MSG="Proceed to PA?"   OK="Next" ONOK="STEP_PA"
  KS_PROMPT_OK_CANCEL TITLE="PA ready?"  MSG="Proceed to Input Shaper?" OK="Next" ONOK="STEP_IS"
  KS_NOTIFY TITLE="Wizard" MSG="üéâ Setup complete. Consider firmware restart." DUR=6
  M117 ‚úÖ Setup complete
