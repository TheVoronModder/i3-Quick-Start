\
# ===== Animated Status for KlipperScreen (DK BE v2 compatible) =====
[gcode_macro ANIM]
description: "Holds animation state"
variable_running: 0
variable_text: "Working..."
variable_interval: 0.2
variable_frame: 0
variable_style: "spinner"   # spinner | dots | bar
gcode:

[gcode_macro ANIM_START]
description: "Start animated status"
gcode:
  {% set style = params.STYLE|default("spinner") %}
  {% set text = params.TEXT|default("Working...") %}
  {% set interval = params.INTERVAL|default(0.2)|float %}
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=style VALUE="{style}"
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=text VALUE="{text}"
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=interval VALUE={interval}
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=frame VALUE=0
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=_ANIM_TICK DURATION=0.01

[gcode_macro ANIM_STOP]
description: "Stop animated status and clear"
gcode:
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=running VALUE=0
  SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=frame VALUE=0
  M117

[delayed_gcode _ANIM_TICK]
initial_duration: 0
gcode:
  {% if printer["gcode_macro ANIM"].running|int == 1 %}
    {% set style  = printer["gcode_macro ANIM"].style %}
    {% set frame  = printer["gcode_macro ANIM"].frame|int %}
    {% set text   = printer["gcode_macro ANIM"].text %}
    {% if style == "spinner" %}
      {% set frames = ["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"] %}
      {% set ch = frames[frame % frames|length] %}
      M117 {ch} {text}
    {% elif style == "dots" %}
      {% set frames = [""," ."," .."," ..."] %}
      {% set ch = frames[frame % frames|length] %}
      M117 {text}{ch}
    {% elif style == "bar" %}
      {% set total = 10 %}
      {% set fill = frame % (total + 1) %}
      {% set bar = ("█" * fill) ~ ("░" * (total - fill)) %}
      M117 {text} [{bar}]
    {% else %}
      M117 {text}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=ANIM VARIABLE=frame VALUE={frame + 1}
    UPDATE_DELAYED_GCODE ID=_ANIM_TICK DURATION={printer["gcode_macro ANIM"].interval}
  {% endif %}
